name: Build Linux Self-Hosted

on:
    workflow_dispatch:

permissions:
    contents: write

jobs:
    build-linux-selfhosted:
        runs-on: self-hosted
        container:
            image: golang:1.25
        strategy:
            matrix:
                include:
                    - goarch: amd64
                      filename: amd64
                    - goarch: arm64
                      filename: arm64
                    - goarch: arm
                      filename: arm32

        steps:
            - name: Setup Build Environment
              run: |
                  set -e
                  # Install dependencies for eBPF generation (clang, llvm, libbpf)
                  apt-get update
                  apt-get install -y --no-install-recommends clang llvm libbpf-dev libc6-dev
                  apt-get update
                  if [ "${{ matrix.goarch }}" = "arm64" ]; then
                    dpkg --add-architecture arm64
                    apt-get update
                    apt-get install -y --no-install-recommends gcc-aarch64-linux-gnu libc6-dev-arm64-cross libpcap-dev:arm64
                  elif [ "${{ matrix.goarch }}" = "arm" ]; then
                    dpkg --add-architecture armhf
                    apt-get update
                    apt-get install -y --no-install-recommends gcc-arm-linux-gnueabihf libc6-dev-armhf-cross libpcap-dev:armhf
                  else
                    apt-get install -y --no-install-recommends build-essential libpcap-dev
                  fi

            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Mark repo as safe
              run: git config --global --add safe.directory $GITHUB_WORKSPACE

            - name: Get tag or commit
              id: ref_id
              shell: bash
              run: |
                  if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
                    REF_ID="${GITHUB_REF#refs/tags/}"
                    echo "Triggered by tag: $REF_ID"
                  else
                    REF_ID=$(git rev-parse --short HEAD)
                    echo "No tag detected. Using commit hash: $REF_ID"
                  fi
                  echo "ref=$REF_ID" >> $GITHUB_OUTPUT

            - name: Generate eBPF
              run: |
                  go generate ./internal/socket/ebpf

            - name: Build
              run: |
                  mkdir -p dist
                  export CGO_ENABLED=1 
                  export GOOS=linux 
                  export GOARCH=${{ matrix.goarch }}
                  export VERSION=${{ steps.ref_id.outputs.ref }}
                  export GIT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
                  export GIT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "unknown")
                  export BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

                  # Set the C compiler for cross-compilation
                  if [ "$GOARCH" = "arm64" ]; then
                    export CC=aarch64-linux-gnu-gcc
                  elif [ "$GOARCH" = "arm" ]; then
                    export CC=arm-linux-gnueabihf-gcc
                    export GOARM=7
                  fi

                  go build -v -a -trimpath \
                    -ldflags "-s -w -buildid= \
                    -X 'paqet/cmd/version.Version=${VERSION}' \
                    -X 'paqet/cmd/version.GitCommit=${GIT_COMMIT}' \
                    -X 'paqet/cmd/version.GitTag=${GIT_TAG}' \
                    -X 'paqet/cmd/version.BuildTime=${BUILD_TIME}'" \
                    -o paqet_linux_${{ matrix.filename }} ./cmd/main.go

                  chmod +x paqet_linux_${{ matrix.filename }}
                  tar -czvf dist/paqet-linux-${{ matrix.filename }}-${{ steps.ref_id.outputs.ref }}.tar.gz \
                    paqet_linux_${{ matrix.filename }} \
                    README.md \
                    example/client.yaml.example \
                    example/server.yaml.example

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: paqet-linux-${{ matrix.filename }}
                  path: dist/paqet-linux-${{ matrix.filename }}-${{ steps.ref_id.outputs.ref }}.tar.gz
                  retention-days: 7
